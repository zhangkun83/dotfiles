#!/bin/bash
DIR="$HOME/orgwork"
BACKUP_DIR="rsync://localhost:1873/x20/users/zh/zhangkun/orgwork"

if [[ "$1" != "upload" ]]; then
    echo "Updating local files ..."
    rsync -rtuv "$BACKUP_DIR/" "$DIR"
    if [[ "$?" -ne 0 ]]; then
        echo "Update failed. Press Enter to open orgwork in READ-ONLY mode ..."
        readonly_hook="(add-hook 'org-mode-hook (lambda() (read-only-mode 1)))"
    else
        echo "Update successful. Press Enter to open orgwork ..."
    fi
    read

    cd $DIR
    # Disable create-lockfiles because it doesn't work well with Google Drive
    emacs --eval="(progn \
                (setq org-agenda-files '(\"$DIR\")\
                      frame-title-format \"orgwork\" )\
                $readonly_hook
                (zk-orgwork-goto-latest-note-file)
                (end-of-buffer))"
fi

if [[ -z "$readonly_hook" ]]; then
    while true; do
        echo "Uploading local changes ..."
        rsync -rtuv "$DIR/" "$BACKUP_DIR" && break
        echo "Upload failed. Press Enter to retry ..."
        read
    done
else
    echo "orgwork was in READ-ONLY mode. Uploading skipped."
fi
