#!/bin/bash
DIR="$HOME/orgwork"
BACKUP_DIR="rsync://localhost:1873/x20/users/zh/zhangkun/orgwork"

if [[ "$1" != "upload" ]]; then
    echo "Downloading remote files ..."
    rsync -rtuv "$BACKUP_DIR/" "$DIR"
    if [[ "$?" -ne 0 ]]; then
        echo "Download FAILED. !!! Press Enter to open orgwork in READ-ONLY mode ... !!!"
        readonly_hook="(add-hook 'org-mode-hook (lambda() (read-only-mode 1)))"
    else
        echo "Download SUCCESSFUL. Press Enter to open orgwork ..."
    fi
    read

    cd $DIR
    echo "Launching Emacs... Have a very safe and productive day."
    # Disable create-lockfiles because it doesn't work well with Google Drive
    emacs --eval="(progn \
                (setq org-agenda-files '(\"$DIR\")\
                      frame-title-format \"orgwork\" )\
                $readonly_hook
                (zk-orgwork-goto-latest-note-file)
                (end-of-buffer))"
    echo "Emacs session ended. Wrapping up ..."
fi

if [[ -z "$readonly_hook" ]]; then
    while true; do
        echo "Uploading local changes ..."
        rsync -rtuv --include='*.org*' --exclude='*' "$DIR/" "$BACKUP_DIR" && break
        echo "Upload FAILED. Press Enter to retry ..."
        read
    done
else
    echo "orgwork was in READ-ONLY mode. Upload skipped."
fi
